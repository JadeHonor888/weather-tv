#include <WiFi.h>
#include <HTTPClient.h>
#include <Arduino_JSON.h>

const char* ssid = "UoB-IoT";    
const char* password = "kag3vp8y"; // Remember to change this to the actual password you got in step 2. 
const char* url ="https://api.openweathermap.org/data/2.5/weather?lat=51.38045&lon=-2.32255&appid=92b9273b242ac133b267f8b8e3e1b6f0";

boolean sun = false;
boolean frozen = false;
boolean rain = false;
boolean cloud = false;
boolean wind = false;
boolean mode = false;

//on or off
boolean on = false; 
boolean buttonPressed = false;

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.println("WiFi connected.");
  
  //set up LEDs
  pinMode(D1, OUTPUT);
  pinMode(D2, OUTPUT);
  pinMode(D3, OUTPUT);
  pinMode(D4, OUTPUT);
  pinMode(D5, OUTPUT);
  pinMode(D6, OUTPUT);

  //set up button
  pinMode(D7, INPUT);
  //turn off yellow LED
  digitalWrite(D1, LOW);

}

void loop() {
  //turn off yellow LED
  digitalWrite(D1, LOW);
  
  delay(100); //for stability

  if (digitalRead(D7)==1)  //button reads high whenever it's pressed
  {
    on = !on;
    buttonPressed = true;
    delay(1000);
    Serial.println("button pressed");
  }

  if(on && buttonPressed)
  {
    weatherSetter();
    turnOnLED();
    buttonPressed = false;
    Serial.println("turning on LEDs...");
  }
  else if (!on && buttonPressed)
  {
    turnOffLED();
    buttonPressed = false;
    Serial.println("turning off LEDs...");
  }
}

void weatherSetter()
{
  //call weather
  reset();
  String i = getIcon();
  checkWeather(i);
}

String getIcon() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(url);
    int httpCode = http.GET();

    if (httpCode > 0) {
      String payload = http.getString();
      Serial.println(httpCode);
      Serial.println(payload);
      //get JSON from http 
      JSONVar json = JSON.parse(payload);

      if (JSON.typeof(json) != "undefined") {
        JSONVar w = json["weather"][0];
        String icon = w["icon"];
        Serial.print("Icon: ");
        Serial.println(icon);
        return icon;
      } 
      else {
      Serial.println("Parsing the JSON failed!");
      return "";
      }

    } else {
      Serial.println("Error on HTTP request");
      return "";
    }
    http.end();
  } else {
    Serial.println("Not connected to WiFi");
    return "";
  }
}

void checkWeather(String i)
{
  if (i.substring(2) == "d")
  {
    sun = true;
    Serial.println("daytime");
  }
  else if (i.substring(2) == "n")
  {
    sun = false;
    Serial.println("nighttime");
  }

  if (i.substring(0,2) == "02")
  {
    cloud = true;
    Serial.println("few clouds");
  }
  else if (i.substring(0,2) == "03")
  {
    cloud = true;
    sun = false;
    Serial.println("scattered clouds");
  }
  else if (i.substring(0,2) == "04")
  {
    cloud = true;
    sun = false;
    Serial.println("broken clouds");
  }
  else if (i.substring(0,2) == "09")
  {
    cloud = true;
    sun = false;
    rain = true;
    Serial.println("shower rain");
  }
  else if (i.substring(0,2) == "10")
  {
    cloud = true;
    rain = true;
    Serial.println("rain");
  }
  else if (i.substring(0,2) == "11")
  {
    cloud = true;
    sun = false;
    rain = true;
    wind = true;
    Serial.println("thunderstorm");
  }
  else if (i.substring(0,2) == "13")
  {
    frozen = true;
    Serial.println("snow");
  }
  else if (i.substring(0,2) == "50")
  {
    cloud = true;
    wind = true;
    Serial.println("mist");
  }
}

void turnOnLED()
{
  if (sun)
  {
    digitalWrite(D1, HIGH);
  }
  if (wind)
  {
    digitalWrite(D2,HIGH);
  }
  if (cloud)
  {
    digitalWrite(D3, HIGH);
  }
  if (rain)
  {
    digitalWrite(D4, HIGH);
  }
  if (mode)
  {
    digitalWrite(D5, HIGH);
  }
  if (frozen)
  {
    digitalWrite(D6, HIGH);
  }
}

void turnOffLED()
{
  if (sun)
  {
    digitalWrite(D1, LOW);
  }
  if (wind)
  {
    digitalWrite(D2,LOW);
  }
  if (cloud)
  {
    digitalWrite(D3, LOW);
  }
  if (rain)
  {
    digitalWrite(D4, LOW);
  }
  if (mode)
  {
    digitalWrite(D5, LOW);
  }
  if (frozen)
  {
    digitalWrite(D6, LOW);
  }
}

void reset()
{
  sun = false;
  frozen = false;
  rain = false;
  cloud = false;
  wind = false;
  mode = false;
}



// digitalWrite(D1, HIGH);
//   delay(3000);
//   digitalWrite(D1,LOW);
//   delay(1000);

//   digitalWrite(D2, HIGH);
//   delay(3000);
//   digitalWrite(D2,LOW);
//   delay(1000);

//   digitalWrite(D3, HIGH);
//   delay(3000);
//   digitalWrite(D3,LOW);
//   delay(1000);

//   digitalWrite(D4, HIGH);
//   delay(3000);
//   digitalWrite(D4,LOW);
//   delay(1000);

//   digitalWrite(D5, HIGH);
//   delay(3000);
//   digitalWrite(D5,LOW);
//   delay(1000);

//   digitalWrite(D6, HIGH);
//   delay(3000);
//   digitalWrite(D6,LOW);
//   delay(1000);
  
//   delay(1000000);
